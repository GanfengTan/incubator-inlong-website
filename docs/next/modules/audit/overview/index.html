<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Inlong Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Inlong Blog Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="Apache Inlong RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/news/atom.xml" title="Apache Inlong Atom Feed"><title data-react-helmet="true">Overview | Apache Inlong</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://inlong.apache.org/docs/next/modules/audit/overview"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Overview | Apache Inlong"><meta data-react-helmet="true" name="description" content="InLong audit is a subsystem independent of InLong, which performs real-time audit and reconciliation on the incoming and outgoing traffic of the Agent, DataProxy, and Sort modules of the InLong system."><meta data-react-helmet="true" property="og:description" content="InLong audit is a subsystem independent of InLong, which performs real-time audit and reconciliation on the incoming and outgoing traffic of the Agent, DataProxy, and Sort modules of the InLong system."><link data-react-helmet="true" rel="shortcut icon" href="/img/logo.svg"><link data-react-helmet="true" rel="canonical" href="https://inlong.apache.org/docs/next/modules/audit/overview"><link data-react-helmet="true" rel="alternate" href="https://inlong.apache.org/docs/next/modules/audit/overview" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://inlong.apache.org/zh-CN/docs/next/modules/audit/overview" hreflang="zh-CN"><link data-react-helmet="true" rel="alternate" href="https://inlong.apache.org/docs/next/modules/audit/overview" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.235f9eab.css">
<link rel="preload" href="/assets/js/runtime~main.da183e42.js" as="script">
<link rel="preload" href="/assets/js/main.e5046002.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" style="background-color:#BBDFFF" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">‚≠êÔ∏è &nbsp; If you like Apache InLong , give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/apache/incubator-inlong">GitHub</a></div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"></path></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Apache" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo.svg" alt="Apache" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Apache InLong</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/">HOME</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/docs/introduction">DOC</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/introduction">Next</a></li><li><a class="dropdown__link" href="/docs/introduction">0.12.0</a></li><li><a class="dropdown__link" href="/docs/0.11.0/user_guide/quick_start">0.11.0</a></li><li><a class="dropdown__link" href="/versions/">All versions</a></li></ul></div><a class="navbar__item navbar__link" href="/download/main">DOWNLOAD</a><a class="navbar__item navbar__link" href="/development/how-to-contribute">DEVELOPMENT</a><a class="navbar__item navbar__link" href="/blog">BLOG</a><a class="navbar__item navbar__link" href="/news">NEWS</a><a class="navbar__item navbar__link" href="/users">USERS</a><a class="navbar__item navbar__link" href="/team">TEAM</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Apache Software Foundation</a></li><li><a href="https://incubator.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Apache Incubator</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg t="1631348384596" class="iconLanguage_EbrZ" viewBox="0 0 1024 1024" version="1.1" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/docs/next/modules/audit/overview" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh-CN/docs/next/modules/audit/overview" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">ÁÆÄ‰Ωì‰∏≠Êñá</a></li></ul></div><a href="https://github.com/apache/incubator-inlong" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">üåû</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/next/introduction">InLong Introduction</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Design and Concept</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Quick Start</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Deployment</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Components</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Agent</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">DataProxy</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">TubeMQ</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Sort</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Manager</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Dashboard</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Sort Standalone</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">audit</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/next/modules/audit/overview">Overview</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/modules/audit/quick_start">Deployment</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">SDK</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">User Guide</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Development</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Administration</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/next/contact">Contact Us</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->Apache Inlong<!-- --> <b>Next</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/introduction">latest version</a></b> (<!-- -->0.12.0<!-- -->).</div></div><div class="docItemContainer_oiyr"><article><span class="theme-doc-version-badge badge badge--secondary">Version: <!-- -->Next</span><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Overview</h1></header><p>InLong audit is a subsystem independent of InLong, which performs real-time audit and reconciliation on the incoming and outgoing traffic of the Agent, DataProxy, and Sort modules of the InLong system.
There are three granularities for reconciliation: minutes, hours, and days.</p><p>The audit reconciliation is based on the log reporting time, and each service participating in the audit will conduct real-time reconciliation according to the same log time. Through audit reconciliation, we can clearly understand InLong
The transmission status of each module, and whether the data stream is lost or repeated</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="architecture"></a>Architecture<a class="hash-link" href="#architecture" title="Direct link to heading">#</a></h2><p><img src="/assets/images/audit_architecture-db492ed7fb88e9baba3327dda5b72a8c.png"></p><ol><li>The audit SDK is nested in the service that needs to be audited, audits the service, and sends the audit result to the audit access layer</li><li>The audit access layer writes audit data to MQ (kafak or pulsar)</li><li>The distribution service consumes the audit data of MQ, and writes the audit data to MySQL and Elasticsearch</li><li>The interface layer encapsulates the data of MySQL and Elasticsearch</li><li>Application scenarios mainly include report display, audit reconciliation, etc.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="audit-dimension"></a>Audit Dimension<a class="hash-link" href="#audit-dimension" title="Direct link to heading">#</a></h2><table><thead><tr><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>Machine ip</td><td>Container ID</td><td>Thread ID</td><td>Log time (minutes)</td><td>Audit ID</td><td>inlong_group_id</td><td>inlong_stream_id</td><td>Number of records</td><td>Size</td><td>Transmission delay (ms)</td></tr></tbody></table><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="audit-id"></a>Audit ID<a class="hash-link" href="#audit-id" title="Direct link to heading">#</a></h2><p>The receiving and sending of each module are respectively an independent audit item ID</p><table><thead><tr><th>Inlong Service Module</th><th>Audit ID</th></tr></thead><tbody><tr><td>Inlong API Received Successfully</td><td>1</td></tr><tr><td>Inlong API Send Successfully</td><td>2</td></tr><tr><td>Inlong Agent Received Successfully</td><td>3</td></tr><tr><td>Inlong Agent Send Successfully</td><td>4</td></tr><tr><td>Inlong DataProxy Received Successfully</td><td>5</td></tr><tr><td>Inlong DataProxy Send Successfully</td><td>6</td></tr><tr><td>Inlong Sort Received Successfully</td><td>7</td></tr><tr><td>Inlong Sort Send Successfully</td><td>8</td></tr></tbody></table><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="data-transfer-protocol"></a>Data Transfer Protocol<a class="hash-link" href="#data-transfer-protocol" title="Direct link to heading">#</a></h2><p>The transmission protocol between sdk, access layer, and distribution layer is Protocol Buffers</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI markdown"><pre tabindex="0" class="prism-code language-markdown codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">syntax = &quot;proto3&quot;;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">package org.apache.inlong.audit.protocol;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message BaseCommand {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    enum Type {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        PING          = 0;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        PONG          = 1;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        AUDITREQUEST  = 2;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        AUDITREPLY    = 3;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Type type                            = 1;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional AuditRequest audit_request  = 2;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional AuditReply audit_reply      = 3;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional Ping ping                   = 4;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional Pong pong                   = 5;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message Ping {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message Pong {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message AuditRequest {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  AuditMessageHeader msg_header = 1;   </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  repeated AuditMessageBody msg_body = 2;   </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message AuditMessageHeader {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  string ip = 1;            </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  string docker_id = 2;     </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  string thread_id = 3;     </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  uint64 sdk_ts = 4;        </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  uint64 packet_id = 5;     </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message AuditMessageBody {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  uint64 log_ts = 1;   </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  string inlong_group_id= 2;   </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  string inlong_stream_id= 3; </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  string audit_id = 4;   </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  uint64 count = 5;     </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  uint64 size = 6;      </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  int64  delay = 7;      </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message AuditReply {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  enum RSP_CODE {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    SUCCESS  = 0;  </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    FAILED   = 1;   </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DISASTER = 2; </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  RSP_CODE rsp_code = 1;   </span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  optional string message = 2;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="audit-sdk-implementation-details"></a>Audit SDK Implementation Details<a class="hash-link" href="#audit-sdk-implementation-details" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="target"></a>Target<a class="hash-link" href="#target" title="Direct link to heading">#</a></h3><p><strong><em>1. Support local disaster recovery</em></strong>
<strong><em>2. Data Uniqueness</em></strong>
<strong><em>3. Reduce data loss caused by abnormal restart</em></strong></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="main-logic-diagram"></a>Main Logic Diagram<a class="hash-link" href="#main-logic-diagram" title="Direct link to heading">#</a></h3><p><img src="/assets/images/audit_sdk-76111ecb81d46749cf0daad888a756a0.png"></p><ol><li>The sdk provides the add interface externally. The parameters are: audit_id, inlong_group_id, inlong_stream_id, number, size.</li><li>The sdk uses log time+audit_id+inlong_group_id+inlong_stream_id as the key to perform real-time statistics.</li><li>When the sending cycle is satisfied or the business program is actively triggered, the SDK will package the statistical results with the PB protocol and send the audit access layer.</li><li>If (4) fails to send, put it into the failure queue, and continue to send in the next cycle.</li><li>When the failure queue is greater than the threshold, perform disaster recovery through local files.</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="service-discovery"></a>Service Discovery<a class="hash-link" href="#service-discovery" title="Direct link to heading">#</a></h3><p>Audit name discovery between sdk and access layer, support plug-in, including domain name, vip, etc.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="disaster-recovery"></a>Disaster Recovery<a class="hash-link" href="#disaster-recovery" title="Direct link to heading">#</a></h3><p><img src="/assets/images/audit_sdk_disaster_recovery-4c48c3a8e253ca1ca7dc99a2be2a4e48.png"></p><ol><li>When the SDK fails to send the access layer, it will be placed in the failure queue.</li><li>When the failure queue reaches the threshold, it will be written to the local disaster recovery file.</li><li>When the local disaster recovery file reaches the threshold, the old data will be eliminated (eliminated by time).</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="access-layer-implementation"></a>Access layer Implementation<a class="hash-link" href="#access-layer-implementation" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="target-1"></a>Target<a class="hash-link" href="#target-1" title="Direct link to heading">#</a></h3><p><strong><em>1.High reliability</em></strong><br>
<strong><em>2.at least once</em></strong>  </p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="main-logic-diagram-1"></a>Main Logic Diagram<a class="hash-link" href="#main-logic-diagram-1" title="Direct link to heading">#</a></h3><p><img src="/assets/images/audit_proxy-da4ab5907594ab9e46b70645c9a0ea91.png"></p><ol><li>After the access layer receives the packet sent by the sdk, it writes the message queue.</li><li>After writing the message queue successfully, return success to the sdk.</li><li>The data protocol of the message queue is the PB protocol.</li><li>Set the ack of the write message queue to -1 or all.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="elasticsearch-distribution-implementation"></a>Elasticsearch Distribution Implementation<a class="hash-link" href="#elasticsearch-distribution-implementation" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="target-2"></a>Target<a class="hash-link" href="#target-2" title="Direct link to heading">#</a></h3><p><strong><em>1. High real-time performance (minute level)</em></strong>
<strong><em>2. Can operate tens of billions of audit data per day</em></strong>
<strong><em>3. Can be deduplicated</em></strong></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="main-logic-diagram-2"></a>Main Logic Diagram<a class="hash-link" href="#main-logic-diagram-2" title="Direct link to heading">#</a></h3><p><img src="/assets/images/elasticsearch_overview-baeacc406471a715846369f35fe0d4d7.png"></p><ol><li>Distribution service AuditDds consumes messages in real time.</li><li>According to the audit ID in the audit data, route the data to the corresponding Elasticsearch cluster.</li><li>Each audit ID corresponds to an Elasticsearch index.</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="elasticsearch-index-design"></a>Elasticsearch Index Design<a class="hash-link" href="#elasticsearch-index-design" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_y2LR" id="index-name"></a>Index Name<a class="hash-link" href="#index-name" title="Direct link to heading">#</a></h4><p>The index name consists of date + audit item ID, such as 20211019_1, 20211019_2.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_y2LR" id="index-field-schema"></a>Index Field Schema<a class="hash-link" href="#index-field-schema" title="Direct link to heading">#</a></h4><table><thead><tr><th>field</th><th>type</th><th>instruction</th></tr></thead><tbody><tr><td>audit_id</td><td>keyword</td><td>Audit ID</td></tr><tr><td>inlong_group_id</td><td>keyword</td><td>inlong_group_id</td></tr><tr><td>inlong_stream_id</td><td>keyword</td><td>inlong_stream_id</td></tr><tr><td>docker_id</td><td>keyword</td><td>ID of the container where the dk is located</td></tr><tr><td>thread_id</td><td>keyword</td><td>thread ID</td></tr><tr><td>packet_id</td><td>keyword</td><td>Package ID reported by sdk</td></tr><tr><td>ip</td><td>keyword</td><td>Machine IP</td></tr><tr><td>log_ts</td><td>keyword</td><td>log time</td></tr><tr><td>sdk_ts</td><td>long</td><td>Audit SDK reporting time</td></tr><tr><td>count</td><td>long</td><td>Number of logs</td></tr><tr><td>size</td><td>long</td><td>size of log</td></tr><tr><td>delay</td><td>long</td><td>The log transfer time, equal to the current machine time minus the log time</td></tr></tbody></table><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_y2LR" id="elasticsearch-index-storage-period"></a>Elasticsearch Index Storage Period<a class="hash-link" href="#elasticsearch-index-storage-period" title="Direct link to heading">#</a></h4><p>Storage by day, storage period is dynamically configurable</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="elasticsearch-write-design"></a>Elasticsearch Write Design<a class="hash-link" href="#elasticsearch-write-design" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="the-relationship-between-inlong_group_id-inlong_stream_id-audit-id-and-elasticsearch-index"></a>The relationship between inlong_group_id, inlong_stream_id, audit ID and Elasticsearch index<a class="hash-link" href="#the-relationship-between-inlong_group_id-inlong_stream_id-audit-id-and-elasticsearch-index" title="Direct link to heading">#</a></h3><p><img src="/assets/images/elasticsearch_index-e91afcde5316b4c42de87b9e3a0e363d.png">
The relationship between inlong_group_id, inlong_stream_id, audit ID and Elasticsearch index is 1:N in system design and service implementation</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="write-routing-policy"></a>Write Routing Policy<a class="hash-link" href="#write-routing-policy" title="Direct link to heading">#</a></h3><p><img src="/assets/images/elasticsearch_write-4408c917c9a09304298f43924a25a625.png">
Use inlong_group_id and inlong_stream_id to route to Elasticsearch shards to ensure that the same inlong_group_id and inlong_stream_id are stored in the same shard
When writing the same inlong_group_id and inlong_stream_id to the same shard, when querying and aggregating, only one shard needs to be processed, which can greatly improve performance</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="optional-deduplicationby-doc_id"></a>Optional DeduplicationBy doc_id<a class="hash-link" href="#optional-deduplicationby-doc_id" title="Direct link to heading">#</a></h3><p>Elasticsearch is resource-intensive for real-time deduplication. This function is optional through configuration.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="use-bulk-batch-method"></a>Use bulk batch method<a class="hash-link" href="#use-bulk-batch-method" title="Direct link to heading">#</a></h3><p>Use bulk to write, each batch of 5000, improve the write performance of the Elasticsearch cluster</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="mysql-distribution-implementation"></a>MySQL Distribution Implementation<a class="hash-link" href="#mysql-distribution-implementation" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="target-3"></a>Target<a class="hash-link" href="#target-3" title="Direct link to heading">#</a></h3><p><strong><em>1. High real-time performance (minute level)</em></strong><br>
<strong><em>2. Simple to deploy</em></strong><br>
<strong><em>3. Can be deduplicated</em></strong>  </p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="main-logic-diagram-3"></a>Main Logic Diagram<a class="hash-link" href="#main-logic-diagram-3" title="Direct link to heading">#</a></h3><p><img src="/assets/images/audit_mysql-527cb86d7d377b0a6e944b2ee2930431.png">
MySQL distribution supports distribution to different MySQL instances according to the audit ID, and supports horizontal expansion.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="usage-introduction"></a>Usage introduction<a class="hash-link" href="#usage-introduction" title="Direct link to heading">#</a></h3><ol><li>When the audit scale of the business is relatively small, less than ten million per day, you can consider using MySQL as the audit storage. Because the deployment of MySQL is much simpler than that of Elasticsearch, the resource cost will be much less.</li><li>If the scale of audit data is large and MySQL cannot support it, you can consider using Elasticsearch as storage. After all, a single Elasticsearch cluster can support tens of billions of audit data and horizontal expansion.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="audit-usage-interface-design"></a>Audit Usage Interface Design<a class="hash-link" href="#audit-usage-interface-design" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="main-logic-diagram-4"></a>Main Logic Diagram<a class="hash-link" href="#main-logic-diagram-4" title="Direct link to heading">#</a></h3><p><img src="/assets/images/audit_api-2fa08b39a7e31207a2cd8bd104525901.png">
The audit interface layer uses SQL to check MySQL or restful to check Elasticsearch. How to check which type of storage the interface uses depends on which type of storage is used.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="ui-interface-display"></a>UI Interface Display<a class="hash-link" href="#ui-interface-display" title="Direct link to heading">#</a></h3><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="main-logic-diagram-5"></a>Main Logic Diagram<a class="hash-link" href="#main-logic-diagram-5" title="Direct link to heading">#</a></h3><p><img src="/assets/images/audit_ui-51d52c5abdbf1615d329fe78b407e151.png">
The front-end page pulls the audit data of each module through the interface layer and displays it.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/apache/incubator-inlong-website/edit/master/docs/modules/audit/overview.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/next/modules/sort-standalone/quick_start"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ <!-- -->Deployment</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/next/modules/audit/quick_start"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Deployment<!-- --> ¬ª</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#architecture" class="table-of-contents__link">Architecture</a></li><li><a href="#audit-dimension" class="table-of-contents__link">Audit Dimension</a></li><li><a href="#audit-id" class="table-of-contents__link">Audit ID</a></li><li><a href="#data-transfer-protocol" class="table-of-contents__link">Data Transfer Protocol</a></li><li><a href="#audit-sdk-implementation-details" class="table-of-contents__link">Audit SDK Implementation Details</a><ul><li><a href="#target" class="table-of-contents__link">Target</a></li><li><a href="#main-logic-diagram" class="table-of-contents__link">Main Logic Diagram</a></li><li><a href="#service-discovery" class="table-of-contents__link">Service Discovery</a></li><li><a href="#disaster-recovery" class="table-of-contents__link">Disaster Recovery</a></li></ul></li><li><a href="#access-layer-implementation" class="table-of-contents__link">Access layer Implementation</a><ul><li><a href="#target-1" class="table-of-contents__link">Target</a></li><li><a href="#main-logic-diagram-1" class="table-of-contents__link">Main Logic Diagram</a></li></ul></li><li><a href="#elasticsearch-distribution-implementation" class="table-of-contents__link">Elasticsearch Distribution Implementation</a><ul><li><a href="#target-2" class="table-of-contents__link">Target</a></li><li><a href="#main-logic-diagram-2" class="table-of-contents__link">Main Logic Diagram</a></li><li><a href="#elasticsearch-index-design" class="table-of-contents__link">Elasticsearch Index Design</a></li></ul></li><li><a href="#elasticsearch-write-design" class="table-of-contents__link">Elasticsearch Write Design</a><ul><li><a href="#the-relationship-between-inlong_group_id-inlong_stream_id-audit-id-and-elasticsearch-index" class="table-of-contents__link">The relationship between inlong_group_id, inlong_stream_id, audit ID and Elasticsearch index</a></li><li><a href="#write-routing-policy" class="table-of-contents__link">Write Routing Policy</a></li><li><a href="#optional-deduplicationby-doc_id" class="table-of-contents__link">Optional DeduplicationBy doc_id</a></li><li><a href="#use-bulk-batch-method" class="table-of-contents__link">Use bulk batch method</a></li></ul></li><li><a href="#mysql-distribution-implementation" class="table-of-contents__link">MySQL Distribution Implementation</a><ul><li><a href="#target-3" class="table-of-contents__link">Target</a></li><li><a href="#main-logic-diagram-3" class="table-of-contents__link">Main Logic Diagram</a></li><li><a href="#usage-introduction" class="table-of-contents__link">Usage introduction</a></li></ul></li><li><a href="#audit-usage-interface-design" class="table-of-contents__link">Audit Usage Interface Design</a><ul><li><a href="#main-logic-diagram-4" class="table-of-contents__link">Main Logic Diagram</a></li><li><a href="#ui-interface-display" class="table-of-contents__link">UI Interface Display</a></li><li><a href="#main-logic-diagram-5" class="table-of-contents__link">Main Logic Diagram</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://inlong.apache.org" target="_blank" rel="noopener noreferrer" class="footerLogoLink_SRtH"><img src="/img/incubator-logo.svg" alt="Apache Inlong" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/img/incubator-logo.svg" alt="Apache Inlong" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></a></div><div class="footer__copyright"><div style="text-align: left;">
          <div>
            <p style="font-family: Avenir-Medium;font-size: 14px;color: #999;line-height: 20px;"> Apache InLong is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the name of Apache TLP sponsor. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF. </p>
          </div>
          <div style="border-top: 1px solid #ccc;min-height: 60px;line-height: 20px;text-align: center;font-family: Avenir-Medium;font-size: 14px;color: #999;display: flex;align-items: center;"><span>Copyright ¬© 2019-2022 The Apache Software Foundation. Apache InLong, InLong, and its feather logo are trademarks of The Apache Software Foundation.</span></div>
        </div></div></div></div></footer></div>
<script src="/assets/js/runtime~main.da183e42.js"></script>
<script src="/assets/js/main.e5046002.js"></script>
</body>
</html>